{% macro image(asset, args = {}, attrs = {}) %}
    {% set imgixUrl = getenv('IMGIX_URL') %}
    {% set baseUrl = getenv('CLOUDFRONT_URL') %}

    {% set width = attrs.width|default('') %}
    {% set height = attrs.height|default('') %}

    {% set width = width ? width : args.width|default('') %}
    {% set height = height ? height : args.height|default('') %}

    {% set width = width|replace(',', '') %}
    {% set height = height|replace(',', '') %}

    {% set attrs = attrs|merge({
        width: null,
        height: null
    })|filter(v => v) %}

    {% if asset.id|default(null) %}
        {% set args = args|filter(v => v)|merge({
            'fp-x': asset.focalPoint.x,
            'fp-y': asset.focalPoint.y
        }) %}

        {% set args = args|merge({
            'crop': asset.hasFocalPoint
                ? 'focalpoint'
                : (args.crop|default(null)
                    ? args.crop
                    : 'faces,center'),
        }) %}

        {% set args = args|filter(v => v) %}

        {% set image = {
            url: asset.url|replace(baseUrl, imgixUrl) ~ '?' ~ args|url_encode
        } %}

        {% set image2x = {
            url: asset.url|replace(baseUrl, imgixUrl) ~ '?' ~ args|merge({
                width: args.width is defined ? args.width * 2 : null,
                height: args.height is defined ? args.height * 2 : null
            })|url_encode
        } %}

        {% if not width and height %}
            {% set width = (min(asset.height, height) * (asset.width / asset.height))|number_format %}
        {% endif %}

        {% if not height and width %}
            {% set height = (min(asset.width, width) * (asset.height / asset.width))|number_format %}
        {% endif %}

        {% set width = width ? width : asset.width %}
        {% set height = height ? height : asset.height %}

        {{ tag('img', attrs|merge({
            width: width|replace(',', ''),
            height: height|replace(',', ''),
            src: 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==',
            srcset: [
                "#{asset.extension == 'gif' ? image.url|split('?')|first : image.url}",
                "#{asset.extension == 'gif' ? image2x.url|split('?')|first : image2x.url} 2x"
            ]|join(', '),
            alt: asset.alt|default(craft.app.config.general.devMode ? 'Unknown image content' : ''),
            loading: 'lazy',
        })) }}
    {% elseif asset %}
        {{ tag('img', attrs|merge({
            width: width|replace(',', ''),
            height: height|replace(',', ''),
            src: "https://picsum.photos/seed/#{asset}/#{width}/#{height ?? width}",
            alt: 'Placeholder Image',
            loading: 'lazy',
        })) }}
    {% endif %}
{% endmacro %}

{% macro src(asset, args = {}) %}{% apply spaceless %}
    {% set imgixUrl = getenv('IMGIX_URL') %}
    {% set baseUrl = getenv('CLOUDFRONT_URL') %}

    {% set width = args.width|default('')|replace(',', '') %}
    {% set height = args.height|default('')|replace(',', '') %}

    {% if asset.id|default(null) %}
        {% set args = args|merge({
            'crop': asset.hasFocalPoint
                ? 'focalpoint' :
                (args.crop|default(null)
                    ? args.crop
                    : 'faces,center'),
        }) %}

        {% set args = args|filter(v => v) %}

        {% set image = {
            url: asset.url|replace(baseUrl, imgixUrl) ~ '?' ~ args|url_encode
        } %}

        {% if not width and height %}
            {% set width = (min(asset.height, height) * (asset.width / asset.height))|number_format %}
        {% endif %}

        {% if not height and width %}
            {% set height = (min(asset.width, width) * (asset.height / asset.width))|number_format %}
        {% endif %}

        {% set width = width ? width : asset.width %}
        {% set height = height ? height : asset.height %}

        {{ "#{asset.extension == 'gif' ? image.url|split('?')|first : image.url}" }}
    {% elseif asset %}
        {{ "https://picsum.photos/seed/#{asset}/#{width}/#{height ?? width}" }}
    {% endif %}
{% endapply %}{% endmacro %}
